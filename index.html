<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
<title>AR City Viewer</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@700;800&display=swap" rel="stylesheet"/>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#06060c;--surface:#0c0c18;--border:#1a1a2e;
  --accent:#00e5ff;--accent2:#ff3060;--accent3:#ffdd00;--accent4:#a855f7;
  --text:#e8eeff;--muted:#404070;
  --mono:'Space Mono',monospace;--display:'Syne',sans-serif;
}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:var(--mono);overflow:hidden;touch-action:none;-webkit-tap-highlight-color:transparent}

/* â”€â”€ SCAN SCREEN â”€â”€ */
#scan-screen{position:fixed;inset:0;z-index:10;display:flex;flex-direction:column;align-items:center;justify-content:center;background:var(--bg)}
.grid{position:fixed;inset:0;pointer-events:none;background-image:linear-gradient(rgba(0,229,255,.025) 1px,transparent 1px),linear-gradient(90deg,rgba(0,229,255,.025) 1px,transparent 1px);background-size:40px 40px}
.scan-hdr{position:absolute;top:0;left:0;right:0;padding:1.3rem 1.5rem;display:flex;align-items:center;justify-content:space-between;background:linear-gradient(180deg,rgba(6,6,12,.95),transparent);z-index:2}
.brand{font-family:var(--display);font-size:1rem;font-weight:800;letter-spacing:.06em}
.brand em{font-style:normal;color:var(--accent)}
.spill{display:flex;align-items:center;gap:.4rem;background:rgba(0,229,255,.07);border:1px solid rgba(0,229,255,.2);border-radius:50px;padding:.26rem .8rem;font-size:.58rem;letter-spacing:.14em;text-transform:uppercase;color:var(--accent)}
.pd{width:6px;height:6px;border-radius:50%;background:var(--accent);animation:blink 1.4s infinite}

/* Viewfinder */
.vfw{position:relative;width:min(300px,80vw);aspect-ratio:1;margin-bottom:1.8rem}
#svid{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;border-radius:14px;background:#000}
#shid{display:none}
.vf{position:absolute;inset:-2px;border-radius:15px;pointer-events:none;z-index:3}
.vf::before,.vf::after,.cbr,.cbl{content:'';position:absolute;width:22px;height:22px;border-style:solid;border-color:var(--accent)}
.vf::before{top:0;left:0;border-width:2.5px 0 0 2.5px;border-radius:4px 0 0 0}
.vf::after{top:0;right:0;border-width:2.5px 2.5px 0 0;border-radius:0 4px 0 0}
.cbr{bottom:0;right:0;border-width:0 2.5px 2.5px 0;border-radius:0 0 4px 0}
.cbl{bottom:0;left:0;border-width:0 0 2.5px 2.5px;border-radius:0 0 0 4px}
.sl{position:absolute;left:5%;right:5%;height:1.5px;background:linear-gradient(90deg,transparent,var(--accent),transparent);animation:scan 2s ease-in-out infinite;z-index:4;opacity:.7}
#qrbox{position:absolute;border:1.5px solid var(--accent);border-radius:4px;box-shadow:0 0 16px rgba(0,229,255,.4),inset 0 0 10px rgba(0,229,255,.05);pointer-events:none;z-index:5;opacity:0;transition:opacity .25s,left .08s,top .08s,width .08s,height .08s}
#qrbox.on{opacity:1}

.hint{font-size:.7rem;line-height:1.8;color:var(--muted);text-align:center;max-width:260px}
.hint strong{color:var(--text)}

#startbtn{position:absolute;bottom:2.2rem;left:50%;transform:translateX(-50%) scale(0);background:linear-gradient(135deg,var(--accent),#0099bb);color:#06060c;font-family:var(--display);font-size:1rem;font-weight:800;letter-spacing:.1em;text-transform:uppercase;border:none;border-radius:50px;padding:.9rem 2.6rem;cursor:pointer;box-shadow:0 0 44px rgba(0,229,255,.4);transition:transform .5s cubic-bezier(.34,1.56,.64,1);z-index:20;white-space:nowrap}
#startbtn.show{transform:translateX(-50%) scale(1)}
#startbtn:active{filter:brightness(.88)}
.blabel{position:absolute;bottom:.85rem;left:50%;transform:translateX(-50%);font-size:.54rem;letter-spacing:.18em;color:var(--muted);text-transform:uppercase;opacity:0;transition:opacity .4s .5s;white-space:nowrap}
.blabel.show{opacity:1}

/* â”€â”€ AR SCREEN â”€â”€ */
#ar-screen{position:fixed;inset:0;z-index:20;display:none;background:#000}
#avid{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
#acv{position:absolute;inset:0;width:100%;height:100%;pointer-events:none}
#asvg{position:absolute;inset:0;width:100%;height:100%;z-index:25;pointer-events:none;overflow:visible}

.arhud{position:absolute;top:0;left:0;right:0;z-index:30;padding:.9rem 1.3rem;background:linear-gradient(180deg,rgba(0,0,0,.82),transparent);display:flex;align-items:center;gap:.7rem;pointer-events:none}
.arhtitle{font-family:var(--display);font-size:.9rem;font-weight:800;color:#fff;flex:1;letter-spacing:.04em}
.arlive{display:flex;align-items:center;gap:.3rem;font-size:.55rem;letter-spacing:.12em;text-transform:uppercase;color:var(--accent);background:rgba(0,229,255,.1);border:1px solid rgba(0,229,255,.2);border-radius:50px;padding:.25rem .7rem}
.arxbtn{width:32px;height:32px;border-radius:50%;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.1);color:#fff;font-size:.88rem;cursor:pointer;display:flex;align-items:center;justify-content:center;pointer-events:auto;transition:background .2s}
.arxbtn:hover{background:rgba(255,255,255,.22)}

#astatus{position:absolute;top:3.8rem;left:50%;transform:translateX(-50%);z-index:30;background:rgba(0,0,0,.55);border:1px solid rgba(255,255,255,.1);backdrop-filter:blur(10px);border-radius:50px;padding:.38rem 1rem;font-size:.58rem;letter-spacing:.1em;color:rgba(255,255,255,.7);white-space:nowrap;display:flex;align-items:center;gap:.4rem;transition:border-color .3s,color .3s}
#astatus.locked{border-color:rgba(0,229,255,.35);color:var(--accent)}

/* Annotation panels */
.ann{position:absolute;z-index:26;pointer-events:none;opacity:0;transition:opacity .6s}
.ann.on{opacity:1}
.atag{font-size:.54rem;letter-spacing:.16em;text-transform:uppercase;color:var(--accent);margin-bottom:.15rem;display:flex;align-items:center;gap:.3rem}
.atag::before{content:'';width:3px;height:3px;border-radius:50%;background:var(--accent);display:inline-block;flex-shrink:0}
.abig{font-family:var(--display);font-size:.9rem;font-weight:800;color:var(--text);line-height:1.1;margin-bottom:.1rem}
.abig.gold{color:var(--accent3)}
.asml{font-size:.52rem;color:var(--muted);letter-spacing:.07em;line-height:1.75}
.abar{height:1.5px;width:65px;background:linear-gradient(90deg,var(--accent),transparent);margin:.3rem 0;border-radius:1px}
.abar.r{background:linear-gradient(270deg,var(--accent),transparent)}

.arfoot{position:absolute;bottom:0;left:0;right:0;z-index:30;padding:1.1rem 1.3rem .9rem;background:linear-gradient(0deg,rgba(0,0,0,.9),transparent);display:flex;align-items:flex-end;gap:.8rem}
.afm{flex:1}
.afsup{font-size:.5rem;letter-spacing:.18em;color:var(--muted);text-transform:uppercase;margin-bottom:.2rem}
.afname{font-family:var(--display);font-size:1.2rem;font-weight:800;line-height:1;color:var(--text)}
.afsub{font-size:.56rem;color:var(--accent);letter-spacing:.12em;margin-top:.18rem}
.afprice{font-family:var(--display);font-size:1.4rem;font-weight:800;color:var(--accent3);text-align:right}
.afdiv{width:1px;height:40px;background:var(--border)}

.sflash{position:absolute;inset:0;background:rgba(0,229,255,.08);pointer-events:none;z-index:28;animation:flash .7s ease-out forwards}

@keyframes blink{0%,100%{opacity:1}50%{opacity:.2}}
@keyframes scan{0%{top:3%}50%{top:95%}100%{top:3%}}
@keyframes flash{0%{opacity:.6}100%{opacity:0}}
</style>
</head>
<body>

<!-- SCAN SCREEN -->
<div id="scan-screen">
  <div class="grid"></div>
  <div class="scan-hdr">
    <span class="brand">AR<em>CITY</em></span>
    <div class="spill"><span class="pd"></span><span id="stxt">SCANNING</span></div>
  </div>
  <div class="vfw">
    <video id="svid" autoplay playsinline muted></video>
    <canvas id="shid"></canvas>
    <div class="vf"><div class="cbr"></div><div class="cbl"></div><div class="sl"></div></div>
    <div id="qrbox"></div>
  </div>
  <p class="hint"><strong>Point at any QR code</strong><br/>City rises from the marker surface</p>
  <button id="startbtn" onclick="launchAR()">LAUNCH AR â†—</button>
  <div class="blabel" id="blabel">QR LOCKED Â· TAP TO LAUNCH</div>
</div>

<!-- AR SCREEN -->
<div id="ar-screen">
  <video id="avid" autoplay playsinline muted></video>
  <canvas id="acv"></canvas>
  <svg id="asvg"></svg>

  <div class="ann" id="ann-a">
    <div class="atag">Development</div>
    <div class="abig">NOVA TOWER</div>
    <div class="asml">Mixed Use Â· 62 Floors</div>
    <div class="abar"></div>
    <div class="asml">HEIGHT Â· 312 m<br/>GFA Â· 184,000 mÂ²<br/>STATUS Â· UNDER CONST.</div>
  </div>
  <div class="ann" id="ann-b">
    <div class="atag" style="justify-content:flex-end">Valuation</div>
    <div class="abig gold" style="text-align:right">$2.4B</div>
    <div class="asml" style="text-align:right">Projected 2027</div>
    <div class="abar r" style="margin-left:auto"></div>
    <div class="asml" style="text-align:right">YIELD Â· 6.8% p.a.<br/>UNITS Â· 480 RESI<br/>RATING Â· AA+</div>
  </div>
  <div class="ann" id="ann-c">
    <div class="atag">Infrastructure</div>
    <div class="abig" style="font-size:.78rem;line-height:1.3">District<br/>Node A-7</div>
    <div class="abar"></div>
    <div class="asml">ROADS Â· 4-LANE<br/>METRO Â· 200m<br/>FIBER Â· GIGABIT</div>
  </div>
  <div class="ann" id="ann-d">
    <div style="background:rgba(168,85,247,.12);border:1px solid rgba(168,85,247,.28);border-radius:5px;padding:.38rem .6rem;display:inline-block">
      <div style="font-size:.5rem;letter-spacing:.14em;color:var(--accent4)">SMART CITY</div>
      <div style="font-family:var(--display);font-size:.75rem;font-weight:800;color:var(--text);margin-top:.1rem">ISO 37122</div>
    </div>
  </div>

  <div class="arhud">
    <span class="arhtitle">AR CITY VIEWER</span>
    <div class="arlive"><span class="pd"></span>LIVE</div>
    <button class="arxbtn" onclick="closeAR()">âœ•</button>
  </div>
  <div id="astatus"><span>âŸ³</span><span id="atxt">Looking for QRâ€¦</span></div>

  <div class="arfoot">
    <div class="afm">
      <div class="afsup">AR / 2024 / MASTERPLAN</div>
      <div class="afname">Nova District</div>
      <div class="afsub">40.7128Â°N Â· 74.0060Â°W</div>
    </div>
    <div class="afdiv"></div>
    <div class="afprice">$2.4<span style="font-size:.7rem">B</span></div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
/* =====================================================
   STATE
===================================================== */
let scanStream = null;
let scanIv     = null;
let qrLocked   = false;
let jsqrReady  = false;
let lastQRData = null;

let arActive   = false;
let renderer   = null;
let scene      = null;
let cam        = null;
let raf        = null;
let city       = null;
let anchor     = null;
let tCv        = null;
let tCx        = null;
let frameN     = 0;
let spawnPct   = 0;
let annShown   = false;
let staleness  = 0;
const MAX_STALE = 30;
let T          = 0;

// Smooth tracking
let targetPos = new THREE.Vector3();
let targetRot = new THREE.Euler();
let targetScale = 1;

const sVid = document.getElementById('svid');
const sHid = document.getElementById('shid');
const aVid = document.getElementById('avid');
const aCv  = document.getElementById('acv');

/* =====================================================
   BOOT
===================================================== */
window.addEventListener('DOMContentLoaded', boot);

async function boot() {
  const jsqrProm = new Promise(resolve => {
    const s = document.createElement('script');
    s.src = 'https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js';
    s.onload  = () => { jsqrReady = true; resolve(); };
    s.onerror = () => resolve();
    document.head.appendChild(s);
  });

  try {
    scanStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } },
      audio: false
    });
  } catch (e) {
    try {
      scanStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
    } catch (e2) {
      document.getElementById('stxt').textContent = 'CAM DENIED';
      showCamError(e2.message);
      return;
    }
  }

  sVid.srcObject = scanStream;
  sVid.onloadedmetadata = () => sVid.play();

  sHid.width  = 640;
  sHid.height = 480;
  const sCx = sHid.getContext('2d', { willReadFrequently: true });

  await jsqrProm;
  scanIv = setInterval(() => scanTick(sCx), 150);
}

function showCamError(msg) {
  const d = document.createElement('div');
  d.style.cssText = 'position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(255,48,96,.15);border:1px solid rgba(255,48,96,.4);border-radius:12px;padding:1.2rem 1.6rem;text-align:center;font-size:.72rem;line-height:1.7;color:#ff8aa8;max-width:260px;z-index:100';
  d.innerHTML = `<div style="font-size:1.4rem;margin-bottom:.5rem">ðŸ“·</div><strong>Camera required</strong><br/>${msg}<br/><br/>Try opening this page via HTTPS or a local server.`;
  document.getElementById('scan-screen').appendChild(d);
}

/* =====================================================
   SCAN TICK
===================================================== */
function scanTick(ctx) {
  if (!jsqrReady || sVid.readyState < 2 || !sVid.videoWidth) return;
  ctx.drawImage(sVid, 0, 0, 640, 480);
  const imgData = ctx.getImageData(0, 0, 640, 480);
  const code    = jsQR(imgData.data, 640, 480, { inversionAttempts: 'dontInvert' });

  if (code) {
    lastQRData = code.data;
    if (!qrLocked) {
      qrLocked = true;
      document.getElementById('stxt').textContent = 'LOCKED';
      document.getElementById('startbtn').classList.add('show');
      document.getElementById('blabel').classList.add('show');
    }
    updateLockBox(code.location);
  }
}

function updateLockBox(loc) {
  const wrap = document.querySelector('.vfw');
  const wr   = wrap.getBoundingClientRect();
  const xs   = [loc.topLeftCorner.x, loc.topRightCorner.x, loc.bottomRightCorner.x, loc.bottomLeftCorner.x];
  const ys   = [loc.topLeftCorner.y, loc.topRightCorner.y, loc.bottomRightCorner.y, loc.bottomLeftCorner.y];
  const pad  = 10;
  const x0   = (Math.min(...xs) / 640) * wr.width  - pad;
  const y0   = (Math.min(...ys) / 480) * wr.height - pad;
  const w    = (Math.max(...xs) / 640) * wr.width  - x0 + pad * 2;
  const h    = (Math.max(...ys) / 480) * wr.height - y0 + pad * 2;
  const el   = document.getElementById('qrbox');
  el.classList.add('on');
  el.style.left   = x0 + 'px';
  el.style.top    = y0 + 'px';
  el.style.width  = w  + 'px';
  el.style.height = h  + 'px';
}

/* =====================================================
   LAUNCH AR
===================================================== */
function launchAR() {
  clearInterval(scanIv);
  document.getElementById('scan-screen').style.display = 'none';
  document.getElementById('ar-screen').style.display   = 'block';

  aVid.srcObject = scanStream;
  aVid.onloadedmetadata = () => aVid.play();

  initAR();
}

function closeAR() {
  teardownAR();
  document.getElementById('ar-screen').style.display   = 'none';
  document.getElementById('scan-screen').style.display = 'flex';

  qrLocked = false;
  lastQRData = null;
  document.getElementById('startbtn').classList.remove('show');
  document.getElementById('blabel').classList.remove('show');
  document.getElementById('qrbox').classList.remove('on');
  document.getElementById('stxt').textContent = 'SCANNING';

  const sCx = sHid.getContext('2d', { willReadFrequently: true });
  scanIv = setInterval(() => scanTick(sCx), 150);
}

/* =====================================================
   AR INIT
===================================================== */
function initAR() {
  arActive  = true;
  frameN    = 0;
  spawnPct  = 0;
  annShown  = false;
  staleness = 0;
  T         = 0;

  renderer = new THREE.WebGLRenderer({ canvas: aCv, alpha: true, antialias: true });
  renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.setClearColor(0x000000, 0);
  renderer.shadowMap.enabled = true;
  renderer.shadowMap.type    = THREE.PCFSoftShadowMap;

  scene = new THREE.Scene();
  cam   = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.001, 1000);
  cam.position.set(0, 0, 0);

  scene.add(new THREE.AmbientLight(0xffffff, 0.6));
  const sun = new THREE.DirectionalLight(0xfff8e0, 1.0);
  sun.position.set(5, 10, 8);
  sun.castShadow = true;
  sun.shadow.mapSize.setScalar(2048);
  sun.shadow.camera.near   = 0.01;
  sun.shadow.camera.far    = 50;
  sun.shadow.camera.left   = sun.shadow.camera.bottom = -3;
  sun.shadow.camera.right  = sun.shadow.camera.top    =  3;
  scene.add(sun);
  
  const fill = new THREE.DirectionalLight(0xaaccff, 0.4);
  fill.position.set(-6, 4, -4);
  scene.add(fill);
  
  const rim = new THREE.DirectionalLight(0x00e5ff, 0.25);
  rim.position.set(0, 8, -10);
  scene.add(rim);

  anchor = new THREE.Object3D();
  scene.add(anchor);

  city = new THREE.Group();
  anchor.add(city);
  city.visible = false;
  
  // Position city ABOVE the anchor (floating above QR)
  city.position.set(0, 0.3, 0); // Elevated 0.3 units above the QR plane
  city.rotation.set(0, 0, 0);

  buildCity(city);

  tCv = document.createElement('canvas');
  tCv.width  = 640;
  tCv.height = 480;
  tCx = tCv.getContext('2d', { willReadFrequently: true });

  window.addEventListener('resize', onResize);
  arLoop();

  setTimeout(spawnCity, 700);
}

/* =====================================================
   CITY BUILDER
===================================================== */
function buildCity(root) {
  const mGlass = new THREE.MeshPhongMaterial({ color:0x88ccdd, emissive:0x002233, shininess:130, specular:0x88ccdd, transparent:true, opacity:.92 });
  const mConc  = new THREE.MeshPhongMaterial({ color:0xaaaacc, emissive:0x050510, shininess:18 });
  const mDark  = new THREE.MeshPhongMaterial({ color:0x1e2f44, emissive:0x050510, shininess:55 });
  const mAccent= new THREE.MeshPhongMaterial({ color:0x00e5ff, emissive:0x004455, shininess:150, specular:0x00e5ff });
  const mGold  = new THREE.MeshPhongMaterial({ color:0xffdd00, emissive:0x332200, shininess:90 });
  const mRoad  = new THREE.MeshPhongMaterial({ color:0x181822, shininess:4 });
  const mGnd   = new THREE.MeshPhongMaterial({ color:0x111118, shininess:2, transparent:true, opacity:0.7 });
  const mWin   = new THREE.MeshPhongMaterial({ color:0x1a3355, emissive:0x0a1a2a, shininess:70, transparent:true, opacity:.82 });
  const mNeon  = c => new THREE.MeshPhongMaterial({ color:c, emissive:c, emissiveIntensity:1.3 });
  const mTree  = new THREE.MeshPhongMaterial({ color:0x1a4422, emissive:0x060f08 });

  // Ground - semi-transparent to show it's floating
  const gnd = new THREE.Mesh(new THREE.PlaneGeometry(1, 1), mGnd);
  gnd.rotation.x = -Math.PI / 2;
  gnd.receiveShadow = true;
  root.add(gnd);

  // Roads
  [[1,0.04],[0.04,1]].forEach(([w,d]) => {
    const r = new THREE.Mesh(new THREE.PlaneGeometry(w, d), mRoad);
    r.rotation.x = -Math.PI / 2; r.position.y = 0.0005;
    root.add(r);
  });

  // Buildings
  const bldgs = [
    [-0.18, -0.12, .155, .155, .75, mGlass,  'tower'],
    [ 0.16, -0.13, .130, .130, .58, mDark,   'tower'],
    [-0.32,  0.06, .115, .18,  .30, mConc,   'block'],
    [ 0.29,  0.09, .135, .115, .26, mDark,   'block'],
    [-0.05,  0.20, .275, .095, .13, mConc,   'podium'],
    [-0.38, -0.22, .090, .090, .19, mDark,   'block'],
    [ 0.36, -0.24, .080, .100, .22, mConc,   'block'],
    [ 0.06, -0.33, .105, .085, .16, mDark,   'block'],
    [-0.23,  0.29, .095, .075, .11, mConc,   'block'],
    [ 0.33,  0.31, .085, .085, .08, mConc,   'block'],
  ];

  bldgs.forEach(([bx, bz, bw, bd, bh, mat, style]) => {
    const g = new THREE.Group();
    g.position.set(bx, 0, bz);

    const body = new THREE.Mesh(new THREE.BoxGeometry(bw, bh, bd), mat.clone());
    body.position.y = bh / 2;
    body.castShadow  = true;
    body.receiveShadow = true;
    g.add(body);

    if (style === 'tower') {
      const sp = new THREE.Mesh(new THREE.ConeGeometry(bw * .07, bh * .22, 8), mAccent.clone());
      sp.position.y = bh + bh * .11; sp.castShadow = true; g.add(sp);

      const rows = Math.floor(bh * 16);
      for (let r = 1; r < rows; r++) {
        const y = r * (bh / rows);
        [-1, 1].forEach(side => {
          const wm = new THREE.Mesh(new THREE.PlaneGeometry(bw * .72, .007), mWin.clone());
          wm.position.set(side * (bw / 2 + .0005), y, 0);
          wm.rotation.y = side === 1 ? 0 : Math.PI;
          g.add(wm);
        });
      }
      const rng = new THREE.Mesh(new THREE.TorusGeometry(bw * .38, .007, 6, 20), mAccent.clone());
      rng.rotation.x = Math.PI / 2; rng.position.y = bh - .003; g.add(rng);
      const bc = new THREE.Mesh(new THREE.SphereGeometry(.006, 8, 8), mNeon(0x00e5ff));
      bc.position.y = bh + bh * .22; g.add(bc);

    } else if (style === 'block') {
      const rf = new THREE.Mesh(new THREE.BoxGeometry(bw * .6, .013, bd * .6), mConc.clone());
      rf.position.y = bh + .006; g.add(rf);
      for (let i = 0; i < 2; i++) {
        const ac = new THREE.Mesh(new THREE.BoxGeometry(.016, .011, .020), mDark.clone());
        ac.position.set((i - .5) * .038, bh + .015, 0); g.add(ac);
      }

    } else if (style === 'podium') {
      const st = new THREE.Mesh(new THREE.BoxGeometry(bw * .65, bh * .28, bd * .65), mConc.clone());
      st.position.y = bh + bh * .14; g.add(st);
    }

    root.add(g);
  });

  // Elevated bridge
  const br = new THREE.Mesh(new THREE.BoxGeometry(.32, .011, .022), mDark.clone());
  br.position.set(-.02, .21, -.13); root.add(br);

  // Street lamps
  [[-0.22, .025], [.22, .025], [-0.22, -.025], [.22, -.025]].forEach(([x, z]) => {
    const pole = new THREE.Mesh(new THREE.CylinderGeometry(.003, .003, .075, 6), mConc.clone());
    pole.position.set(x, .0375, z); root.add(pole);
    const lamp = new THREE.Mesh(new THREE.SphereGeometry(.005, 6, 6), mNeon(0xffffaa));
    lamp.position.set(x, .078, z); root.add(lamp);
  });

  // Neon sign
  const ns = new THREE.Mesh(new THREE.BoxGeometry(.055, .011, .002), mNeon(0x00e5ff));
  ns.position.set(-.05, .143, .185); root.add(ns);

  // Ground glow
  const gg = new THREE.Mesh(new THREE.CircleGeometry(.26, 32),
    new THREE.MeshBasicMaterial({ color:0x001a22, transparent:true, opacity:.65 }));
  gg.rotation.x = -Math.PI / 2; gg.position.y = 0.0003; root.add(gg);

  // Central plaza
  const pl = new THREE.Mesh(new THREE.BoxGeometry(.11, .005, .11),
    new THREE.MeshPhongMaterial({ color:0x252535, shininess:8 }));
  pl.position.y = .0025; root.add(pl);

  // Plaza trees
  [[-0.038, -.038], [.038, -.038], [-.038, .038], [.038, .038]].forEach(([x, z]) => {
    const t = new THREE.Mesh(new THREE.ConeGeometry(.008, .022, 6), mTree.clone());
    t.position.set(x, .011, z); root.add(t);
  });
}

/* =====================================================
   SPAWN CITY
===================================================== */
function spawnCity() {
  city.visible = true;
  spawnPct = 0;

  const fl = document.createElement('div');
  fl.className = 'sflash';
  document.getElementById('ar-screen').appendChild(fl);
  setTimeout(() => fl.remove(), 800);

  setTimeout(showAnnotations, 1200);
}

/* =====================================================
   AR LOOP
===================================================== */
function arLoop() {
  if (!arActive) return;
  raf = requestAnimationFrame(arLoop);
  T += 0.016;
  frameN++;

  // Track QR every 2 frames for better responsiveness
  if (frameN % 2 === 0 && jsqrReady && aVid.readyState >= 2 && aVid.videoWidth) {
    trackQR();
  }

  // Grow in
  if (city.visible && spawnPct < 1) {
    spawnPct = Math.min(1, spawnPct + 0.04);
  }

  // Apply smooth transform to anchor (which moves the entire city with it)
  anchor.position.lerp(targetPos, 0.35);
  anchor.rotation.x += (targetRot.x - anchor.rotation.x) * 0.3;
  anchor.rotation.y += (targetRot.y - anchor.rotation.y) * 0.3;
  anchor.rotation.z += (targetRot.z - anchor.rotation.z) * 0.3;
  
  const currentScale = city.scale.x;
  const newScale = currentScale + (targetScale * spawnPct - currentScale) * 0.22;
  city.scale.setScalar(newScale);

  // Subtle floating animation
  if (city.visible) {
    city.position.y = 0.3 + Math.sin(T * 0.8) * 0.008;
    city.rotation.y = Math.sin(T * 0.3) * 0.02;
  }

  // Staleness
  if (staleness > MAX_STALE) {
    document.getElementById('astatus').classList.remove('locked');
    document.getElementById('atxt').textContent = 'Looking for QRâ€¦';
  } else {
    staleness++;
  }

  if (annShown) drawAnnLines();

  renderer.render(scene, cam);
}

/* =====================================================
   QR TRACKING
===================================================== */
function trackQR() {
  tCx.drawImage(aVid, 0, 0, 640, 480);
  const id   = tCx.getImageData(0, 0, 640, 480);
  const code = jsQR(id.data, 640, 480, { inversionAttempts: 'dontInvert' });

  if (code) {
    applyQRTransform(code.location);
    staleness = 0;
    document.getElementById('astatus').classList.add('locked');
    document.getElementById('atxt').textContent = 'Anchored to QR';
  }
}

function applyQRTransform(loc) {
  const W = 640, H = 480;

  const TL = { x: loc.topLeftCorner.x / W, y: loc.topLeftCorner.y / H };
  const TR = { x: loc.topRightCorner.x / W, y: loc.topRightCorner.y / H };
  const BR = { x: loc.bottomRightCorner.x / W, y: loc.bottomRightCorner.y / H };
  const BL = { x: loc.bottomLeftCorner.x / W, y: loc.bottomLeftCorner.y / H };

  const cx = ((TL.x + TR.x + BR.x + BL.x) / 4 - 0.5) * 2;
  const cy = -((TL.y + TR.y + BR.y + BL.y) / 4 - 0.5) * 2;

  const edgeT = Math.hypot(TR.x - TL.x, TR.y - TL.y);
  const edgeB = Math.hypot(BR.x - BL.x, BR.y - BL.y);
  const ndcAvg = (edgeT + edgeB) / 2;   // simplified

  // â”€â”€ Main tuning parameters â”€â”€
  const DESIRED_DISTANCE = 1.4;           // meters â€” feel free to try 0.9â€“2.0
  const SCALE_MULTIPLIER = 2.2;           // most important knob â€” 1.2 to 3.5 range

  const depth = DESIRED_DISTANCE;         // â† start simple
  // or keep perspective attempt: const depth = 0.9 / (ndcAvg + 0.02);

  const fov = THREE.MathUtils.degToRad(cam.fov);
  const scH = 2 * Math.tan(fov / 2) * depth;
  const scW = scH * cam.aspect;

  const wx = cx * scW / 2;
  const wy = cy * scH / 2;
  const wz = -depth;

  targetPos.set(wx, wy, wz);

  const yaw   = Math.atan2(-(TR.y - TL.y), TR.x - TL.x);
  const pitch = Math.atan2((edgeT - edgeB) * 2.0, 1.0) * 0.6;
  const roll  = Math.atan2((edgeR - edgeL) * 2.0, 1.0) * 0.6;
  targetRot.set(pitch, yaw, roll);

  const qrWorld = ndcAvg * scW;
  targetScale = qrWorld * SCALE_MULTIPLIER;

  console.log(`scale â†’ ${targetScale.toFixed(3)}  |  depth ${depth.toFixed(2)}m  |  ndc ${ndcAvg.toFixed(3)}`);
}

/* =====================================================
   ANNOTATIONS
===================================================== */
const ANNS = [
  { id: 'ann-a', lp: [-0.18, 0.95, 0],  side: 'left'  },
  { id: 'ann-b', lp: [ 0.18, 0.90, 0],  side: 'right' },
  { id: 'ann-c', lp: [-0.10, 0.28, 0],  side: 'left'  },
  { id: 'ann-d', lp: [ 0.09, 0.74, 0],  side: 'right' },
];
const ANN_POS = {
  'ann-a': { left: '3vw',  top: '18%', right: 'auto', bottom: 'auto' },
  'ann-b': { right:'3vw',  top: '18%', left:  'auto', bottom: 'auto' },
  'ann-c': { left: '3vw',  top: '63%', right: 'auto', bottom: 'auto' },
  'ann-d': { right:'3vw',  top: '63%', left:  'auto', bottom: 'auto' },
};

function showAnnotations() {
  annShown = true;
  ANNS.forEach(a => {
    const el = document.getElementById(a.id);
    Object.assign(el.style, ANN_POS[a.id]);
    el.classList.add('on');
  });
}

const _vp = new THREE.Vector3();
function proj(lx, ly, lz) {
  _vp.set(lx, ly, lz);
  _vp.applyMatrix4(city.matrixWorld);
  _vp.project(cam);
  return {
    x: (_vp.x *  0.5 + 0.5) * window.innerWidth,
    y: (_vp.y * -0.5 + 0.5) * window.innerHeight,
    behind: _vp.z > 1
  };
}

function edgePt(id, tx, ty) {
  const el = document.getElementById(id);
  const r  = el.getBoundingClientRect();
  const cx = r.left + r.width  / 2;
  const cy = r.top  + r.height / 2;
  const dx = tx - cx, dy = ty - cy;
  const len = Math.hypot(dx, dy) || 1;
  return {
    x: Math.max(r.left, Math.min(r.right,  cx + (dx / len) * (r.width  / 2 + 4))),
    y: Math.max(r.top,  Math.min(r.bottom, cy + (dy / len) * (r.height / 2 + 4)))
  };
}

function drawAnnLines() {
  if (spawnPct < 0.35) return;
  const svg   = document.getElementById('asvg');
  svg.innerHTML = '';
  const alpha = Math.min(1, (spawnPct - 0.35) / 0.35);

  ANNS.forEach(a => {
    const el = document.getElementById(a.id);
    if (!el.classList.contains('on')) return;

    const pt = proj(...a.lp);
    if (pt.behind) return;

    const edge = edgePt(a.id, pt.x, pt.y);
    const midX = a.side === 'left' ? (pt.x + edge.x) / 2 - 16 : (pt.x + edge.x) / 2 + 16;
    const midY = (pt.y + edge.y) / 2;

    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    path.setAttribute('d', `M${edge.x},${edge.y} L${midX},${midY} L${pt.x},${pt.y}`);
    path.setAttribute('stroke', `rgba(0,229,255,${0.48 * alpha})`);
    path.setAttribute('stroke-width', '0.85');
    path.setAttribute('stroke-dasharray', '4 3');
    path.setAttribute('fill', 'none');
    svg.appendChild(path);

    const dot = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    dot.setAttribute('cx', pt.x); dot.setAttribute('cy', pt.y);
    dot.setAttribute('r', '2.5'); dot.setAttribute('fill', `rgba(0,229,255,${0.9 * alpha})`);
    svg.appendChild(dot);

    const ring = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    ring.setAttribute('cx', pt.x); ring.setAttribute('cy', pt.y);
    ring.setAttribute('r', '5.5'); ring.setAttribute('fill', 'none');
    ring.setAttribute('stroke', `rgba(0,229,255,${0.28 * alpha})`);
    ring.setAttribute('stroke-width', '1');
    svg.appendChild(ring);

    const tw   = a.side === 'left' ? -8 : 8;
    const tick = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    tick.setAttribute('x1', edge.x); tick.setAttribute('y1', edge.y);
    tick.setAttribute('x2', edge.x + tw); tick.setAttribute('y2', edge.y);
    tick.setAttribute('stroke', `rgba(0,229,255,${0.62 * alpha})`);
    tick.setAttribute('stroke-width', '1.4');
    svg.appendChild(tick);
  });
}

/* =====================================================
   TEARDOWN
===================================================== */
function teardownAR() {
  arActive  = false;
  annShown  = false;
  spawnPct  = 0;
  staleness = 0;
  frameN    = 0;
  if (raf)      cancelAnimationFrame(raf);
  if (renderer) { renderer.dispose(); renderer = null; }
  city    = null;
  anchor  = null;
  scene   = null;
  cam     = null;
  document.getElementById('asvg').innerHTML = '';
  document.querySelectorAll('.ann').forEach(e => e.classList.remove('on'));
  window.removeEventListener('resize', onResize);
}

function onResize() {
  if (!renderer || !cam) return;
  cam.aspect = window.innerWidth / window.innerHeight;
  cam.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
}
</script>
</body>
</html>