<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
<title>AR City Viewer</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@700;800&display=swap" rel="stylesheet"/>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#06060c;--surface:#0c0c18;--border:#1a1a2e;
  --accent:#00e5ff;--accent2:#ff3060;--accent3:#ffdd00;--accent4:#a855f7;
  --text:#e8eeff;--muted:#404070;
  --mono:'Space Mono',monospace;--display:'Syne',sans-serif;
}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:var(--mono);overflow:hidden;touch-action:none;-webkit-tap-highlight-color:transparent}

/* ── LOADING SCREEN ── */
#loading{position:fixed;inset:0;z-index:100;display:flex;flex-direction:column;align-items:center;justify-content:center;background:var(--bg)}
.grid{position:fixed;inset:0;pointer-events:none;background-image:linear-gradient(rgba(0,229,255,.025) 1px,transparent 1px),linear-gradient(90deg,rgba(0,229,255,.025) 1px,transparent 1px);background-size:40px 40px}
.load-hdr{position:absolute;top:0;left:0;right:0;padding:1.3rem 1.5rem;display:flex;align-items:center;justify-content:space-between;background:linear-gradient(180deg,rgba(6,6,12,.95),transparent);z-index:2}
.brand{font-family:var(--display);font-size:1rem;font-weight:800;letter-spacing:.06em}
.brand em{font-style:normal;color:var(--accent)}
.spill{display:flex;align-items:center;gap:.4rem;background:rgba(0,229,255,.07);border:1px solid rgba(0,229,255,.2);border-radius:50px;padding:.26rem .8rem;font-size:.58rem;letter-spacing:.14em;text-transform:uppercase;color:var(--accent)}
.pd{width:6px;height:6px;border-radius:50%;background:var(--accent);animation:blink 1.4s infinite}

.spinner{width:60px;height:60px;border:3px solid rgba(0,229,255,.1);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite;margin-bottom:1.5rem}
.load-msg{font-size:.72rem;color:var(--muted);text-align:center;max-width:280px;line-height:1.8}
.load-msg strong{color:var(--text)}

/* ── AR CONTAINER ── */
#ar-container{position:fixed;inset:0;z-index:1;display:none}
.a-canvas{position:absolute!important;top:0!important;left:0!important;width:100%!important;height:100%!important}

/* ── AR HUD ── */
.arhud{position:fixed;top:0;left:0;right:0;z-index:30;padding:.9rem 1.3rem;background:linear-gradient(180deg,rgba(0,0,0,.82),transparent);display:flex;align-items:center;gap:.7rem;pointer-events:none}
.arhtitle{font-family:var(--display);font-size:.9rem;font-weight:800;color:#fff;flex:1;letter-spacing:.04em}
.arlive{display:flex;align-items:center;gap:.3rem;font-size:.55rem;letter-spacing:.12em;text-transform:uppercase;color:var(--accent);background:rgba(0,229,255,.1);border:1px solid rgba(0,229,255,.2);border-radius:50px;padding:.25rem .7rem}
.arxbtn{width:32px;height:32px;border-radius:50%;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.1);color:#fff;font-size:.88rem;cursor:pointer;display:flex;align-items:center;justify-content:center;pointer-events:auto;transition:background .2s}
.arxbtn:hover{background:rgba(255,255,255,.22)}

#astatus{position:fixed;top:3.8rem;left:50%;transform:translateX(-50%);z-index:30;background:rgba(0,0,0,.55);border:1px solid rgba(255,255,255,.1);backdrop-filter:blur(10px);border-radius:50px;padding:.38rem 1rem;font-size:.58rem;letter-spacing:.1em;color:rgba(255,255,255,.7);white-space:nowrap;display:flex;align-items:center;gap:.4rem;transition:border-color .3s,color .3s}
#astatus.locked{border-color:rgba(0,229,255,.35);color:var(--accent)}

/* Annotation panels */
.ann{position:fixed;z-index:26;pointer-events:none;opacity:0;transition:opacity .6s}
.ann.on{opacity:1}
.atag{font-size:.54rem;letter-spacing:.16em;text-transform:uppercase;color:var(--accent);margin-bottom:.15rem;display:flex;align-items:center;gap:.3rem}
.atag::before{content:'';width:3px;height:3px;border-radius:50%;background:var(--accent);display:inline-block;flex-shrink:0}
.abig{font-family:var(--display);font-size:.9rem;font-weight:800;color:var(--text);line-height:1.1;margin-bottom:.1rem}
.abig.gold{color:var(--accent3)}
.asml{font-size:.52rem;color:var(--muted);letter-spacing:.07em;line-height:1.75}
.abar{height:1.5px;width:65px;background:linear-gradient(90deg,var(--accent),transparent);margin:.3rem 0;border-radius:1px}
.abar.r{background:linear-gradient(270deg,var(--accent),transparent)}

.arfoot{position:fixed;bottom:0;left:0;right:0;z-index:30;padding:1.1rem 1.3rem .9rem;background:linear-gradient(0deg,rgba(0,0,0,.9),transparent);display:flex;align-items:flex-end;gap:.8rem}
.afm{flex:1}
.afsup{font-size:.5rem;letter-spacing:.18em;color:var(--muted);text-transform:uppercase;margin-bottom:.2rem}
.afname{font-family:var(--display);font-size:1.2rem;font-weight:800;line-height:1;color:var(--text)}
.afsub{font-size:.56rem;color:var(--accent);letter-spacing:.12em;margin-top:.18rem}
.afprice{font-family:var(--display);font-size:1.4rem;font-weight:800;color:var(--accent3);text-align:right}
.afdiv{width:1px;height:40px;background:var(--border)}

.sflash{position:fixed;inset:0;background:rgba(0,229,255,.08);pointer-events:none;z-index:28;animation:flash .7s ease-out forwards}

#asvg{position:fixed;inset:0;width:100%;height:100%;z-index:25;pointer-events:none;overflow:visible}

.instructions{position:fixed;bottom:6rem;left:50%;transform:translateX(-50%);z-index:30;background:rgba(0,0,0,.7);border:1px solid rgba(0,229,255,.3);backdrop-filter:blur(10px);border-radius:12px;padding:1rem 1.5rem;font-size:.65rem;color:var(--muted);text-align:center;max-width:320px;line-height:1.8}
.instructions strong{color:var(--accent);display:block;margin-bottom:.3rem;font-size:.72rem;letter-spacing:.08em}

@keyframes blink{0%,100%{opacity:1}50%{opacity:.2}}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes flash{0%{opacity:.6}100%{opacity:0}}
</style>
</head>
<body>

<!-- LOADING SCREEN -->
<div id="loading">
  <div class="grid"></div>
  <div class="load-hdr">
    <span class="brand">AR<em>CITY</em></span>
    <div class="spill"><span class="pd"></span><span id="stxt">INITIALIZING</span></div>
  </div>
  <div class="spinner"></div>
  <p class="load-msg"><strong>Loading AR Engine</strong><br/>Please allow camera access when prompted</p>
</div>

<!-- AR CONTAINER -->
<div id="ar-container"></div>

<!-- AR HUD -->
<div class="arhud" style="display:none" id="hud">
  <span class="arhtitle">AR CITY VIEWER</span>
  <div class="arlive"><span class="pd"></span>LIVE</div>
  <button class="arxbtn" onclick="window.location.reload()">✕</button>
</div>

<div id="astatus" style="display:none"><span>⟳</span><span id="atxt">Looking for marker…</span></div>

<div class="instructions" style="display:none" id="instructions">
  <strong>Point camera at any QR code</strong>
  The city will appear floating above it
</div>

<!-- Annotations -->
<div class="ann" id="ann-a">
  <div class="atag">Development</div>
  <div class="abig">NOVA TOWER</div>
  <div class="asml">Mixed Use · 62 Floors</div>
  <div class="abar"></div>
  <div class="asml">HEIGHT · 312 m<br/>GFA · 184,000 m²<br/>STATUS · UNDER CONST.</div>
</div>
<div class="ann" id="ann-b">
  <div class="atag" style="justify-content:flex-end">Valuation</div>
  <div class="abig gold" style="text-align:right">$2.4B</div>
  <div class="asml" style="text-align:right">Projected 2027</div>
  <div class="abar r" style="margin-left:auto"></div>
  <div class="asml" style="text-align:right">YIELD · 6.8% p.a.<br/>UNITS · 480 RESI<br/>RATING · AA+</div>
</div>
<div class="ann" id="ann-c">
  <div class="atag">Infrastructure</div>
  <div class="abig" style="font-size:.78rem;line-height:1.3">District<br/>Node A-7</div>
  <div class="abar"></div>
  <div class="asml">ROADS · 4-LANE<br/>METRO · 200m<br/>FIBER · GIGABIT</div>
</div>
<div class="ann" id="ann-d">
  <div style="background:rgba(168,85,247,.12);border:1px solid rgba(168,85,247,.28);border-radius:5px;padding:.38rem .6rem;display:inline-block">
    <div style="font-size:.5rem;letter-spacing:.14em;color:var(--accent4)">SMART CITY</div>
    <div style="font-family:var(--display);font-size:.75rem;font-weight:800;color:var(--text);margin-top:.1rem">ISO 37122</div>
  </div>
</div>

<div class="arfoot" style="display:none" id="footer">
  <div class="afm">
    <div class="afsup">AR / 2024 / MASTERPLAN</div>
    <div class="afname">Nova District</div>
    <div class="afsub">40.7128°N · 74.0060°W</div>
  </div>
  <div class="afdiv"></div>
  <div class="afprice">$2.4<span style="font-size:.7rem">B</span></div>
</div>

<svg id="asvg"></svg>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/aframe/build/aframe-ar.min.js"></script>
<script>
/* =====================================================
   STATE
===================================================== */
let renderer, scene, camera, markerRoot;
let city, annShown = false, spawnPct = 0, markerVisible = false;
let frameCount = 0, T = 0;

const ANNS = [
  { id: 'ann-a', lp: [-0.18, 0.95, 0],  side: 'left'  },
  { id: 'ann-b', lp: [ 0.18, 0.90, 0],  side: 'right' },
  { id: 'ann-c', lp: [-0.10, 0.28, 0],  side: 'left'  },
  { id: 'ann-d', lp: [ 0.09, 0.74, 0],  side: 'right' },
];
const ANN_POS = {
  'ann-a': { left: '3vw',  top: '18%', right: 'auto', bottom: 'auto' },
  'ann-b': { right:'3vw',  top: '18%', left:  'auto', bottom: 'auto' },
  'ann-c': { left: '3vw',  top: '63%', right: 'auto', bottom: 'auto' },
  'ann-d': { right:'3vw',  top: '63%', left:  'auto', bottom: 'auto' },
};

/* =====================================================
   INIT AR
===================================================== */
window.addEventListener('load', initAR);

async function initAR() {
  try {
    // Request camera access first
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: 'environment' },
      audio: false
    });
    
    // Stop the test stream
    stream.getTracks().forEach(track => track.stop());
    
    // Setup AR.js with barcode tracking (works with any QR/barcode)
    const arToolkitSource = new THREEx.ArToolkitSource({
      sourceType: 'webcam',
      sourceWidth: 1280,
      sourceHeight: 720,
    });

    arToolkitSource.init(() => {
      setTimeout(() => {
        onResize();
      }, 2000);
    });

    // Initialize renderer
    renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setClearColor(new THREE.Color('black'), 0);
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.domElement.style.position = 'absolute';
    renderer.domElement.style.top = '0';
    renderer.domElement.style.left = '0';
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;
    document.getElementById('ar-container').appendChild(renderer.domElement);

    // Initialize scene and camera
    scene = new THREE.Scene();
    camera = new THREE.Camera();
    scene.add(camera);

    // Setup AR.js context
    const arToolkitContext = new THREEx.ArToolkitContext({
      cameraParametersUrl: 'https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/data/data/camera_para.dat',
      detectionMode: 'mono',
    });

    arToolkitContext.init(() => {
      camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix());
    });

    // Create marker root - tracks ANY barcode/QR
    const arMarkerControls = new THREEx.ArMarkerControls(arToolkitContext, camera, {
      type: 'barcode',
      barcodeValue: 0, // Will detect any barcode
      changeMatrixMode: 'cameraTransformMatrix',
      smooth: true,
      smoothCount: 10,
      smoothTolerance: 0.01,
      smoothThreshold: 2,
    });

    markerRoot = new THREE.Group();
    scene.add(markerRoot);

    // Add lights
    scene.add(new THREE.AmbientLight(0xffffff, 0.6));
    
    const sun = new THREE.DirectionalLight(0xfff8e0, 1.0);
    sun.position.set(2, 4, 3);
    sun.castShadow = true;
    sun.shadow.mapSize.setScalar(1024);
    sun.shadow.camera.near = 0.1;
    sun.shadow.camera.far = 20;
    sun.shadow.camera.left = sun.shadow.camera.bottom = -2;
    sun.shadow.camera.right = sun.shadow.camera.top = 2;
    scene.add(sun);
    
    const fill = new THREE.DirectionalLight(0xaaccff, 0.4);
    fill.position.set(-3, 2, -2);
    scene.add(fill);
    
    const rim = new THREE.DirectionalLight(0x00e5ff, 0.25);
    rim.position.set(0, 4, -5);
    scene.add(rim);

    // Build city
    city = new THREE.Group();
    city.position.set(0, 0.15, 0); // Float above marker
    city.scale.setScalar(0.01);
    markerRoot.add(city);
    buildCity(city);

    // Hide loading, show AR interface
    document.getElementById('loading').style.display = 'none';
    document.getElementById('ar-container').style.display = 'block';
    document.getElementById('hud').style.display = 'flex';
    document.getElementById('astatus').style.display = 'flex';
    document.getElementById('instructions').style.display = 'block';
    document.getElementById('footer').style.display = 'flex';

    // Start render loop
    let lastMarkerVisible = false;
    
    function animate() {
      requestAnimationFrame(animate);
      frameCount++;
      T += 0.016;

      if (arToolkitSource.ready) {
        arToolkitContext.update(arToolkitSource.domElement);
      }

      // Check if marker is visible
      markerVisible = arMarkerControls.object3d.visible;
      
      if (markerVisible && !lastMarkerVisible) {
        onMarkerFound();
      } else if (!markerVisible && lastMarkerVisible) {
        onMarkerLost();
      }
      
      lastMarkerVisible = markerVisible;

      // Animate city
      if (markerVisible && spawnPct < 1) {
        spawnPct = Math.min(1, spawnPct + 0.03);
        city.scale.setScalar(spawnPct * 0.5); // Fixed scale: 0.5 world units
      }

      // Subtle floating animation
      if (markerVisible) {
        city.position.y = 0.15 + Math.sin(T * 0.8) * 0.01;
        city.rotation.y = Math.sin(T * 0.3) * 0.03;
      }

      if (annShown && markerVisible) {
        drawAnnLines();
      }

      renderer.render(scene, camera);
    }

    animate();
    window.addEventListener('resize', onResize);

  } catch (error) {
    console.error('AR Init Error:', error);
    document.getElementById('stxt').textContent = 'ERROR';
    document.querySelector('.load-msg').innerHTML = `<strong>Camera Access Denied</strong><br/>Please allow camera permissions and reload the page.<br/><br/>${error.message}`;
  }
}

function onMarkerFound() {
  console.log('Marker found');
  document.getElementById('astatus').classList.add('locked');
  document.getElementById('atxt').textContent = 'Marker locked';
  
  spawnPct = 0;
  
  // Flash effect
  const fl = document.createElement('div');
  fl.className = 'sflash';
  document.body.appendChild(fl);
  setTimeout(() => fl.remove(), 700);
  
  // Show annotations after delay
  setTimeout(() => {
    if (markerVisible) showAnnotations();
  }, 1200);
}

function onMarkerLost() {
  console.log('Marker lost');
  document.getElementById('astatus').classList.remove('locked');
  document.getElementById('atxt').textContent = 'Looking for marker…';
  hideAnnotations();
}

function showAnnotations() {
  annShown = true;
  ANNS.forEach(a => {
    const el = document.getElementById(a.id);
    Object.assign(el.style, ANN_POS[a.id]);
    el.classList.add('on');
  });
}

function hideAnnotations() {
  annShown = false;
  document.querySelectorAll('.ann').forEach(el => el.classList.remove('on'));
  document.getElementById('asvg').innerHTML = '';
}

function onResize() {
  if (renderer && camera) {
    renderer.setSize(window.innerWidth, window.innerHeight);
  }
}

/* =====================================================
   CITY BUILDER
===================================================== */
function buildCity(root) {
  const mGlass = new THREE.MeshPhongMaterial({ color:0x88ccdd, emissive:0x002233, shininess:130, specular:0x88ccdd, transparent:true, opacity:.92 });
  const mConc  = new THREE.MeshPhongMaterial({ color:0xaaaacc, emissive:0x050510, shininess:18 });
  const mDark  = new THREE.MeshPhongMaterial({ color:0x1e2f44, emissive:0x050510, shininess:55 });
  const mAccent= new THREE.MeshPhongMaterial({ color:0x00e5ff, emissive:0x004455, shininess:150, specular:0x00e5ff });
  const mRoad  = new THREE.MeshPhongMaterial({ color:0x181822, shininess:4 });
  const mGnd   = new THREE.MeshPhongMaterial({ color:0x111118, shininess:2, transparent:true, opacity:0.7 });
  const mWin   = new THREE.MeshPhongMaterial({ color:0x1a3355, emissive:0x0a1a2a, shininess:70, transparent:true, opacity:.82 });
  const mNeon  = c => new THREE.MeshPhongMaterial({ color:c, emissive:c, emissiveIntensity:1.3 });
  const mTree  = new THREE.MeshPhongMaterial({ color:0x1a4422, emissive:0x060f08 });

  // Ground
  const gnd = new THREE.Mesh(new THREE.PlaneGeometry(1, 1), mGnd);
  gnd.rotation.x = -Math.PI / 2;
  gnd.receiveShadow = true;
  root.add(gnd);

  // Roads
  [[1,0.04],[0.04,1]].forEach(([w,d]) => {
    const r = new THREE.Mesh(new THREE.PlaneGeometry(w, d), mRoad);
    r.rotation.x = -Math.PI / 2;
    r.position.y = 0.0005;
    root.add(r);
  });

  // Buildings
  const bldgs = [
    [-0.18, -0.12, .155, .155, .75, mGlass,  'tower'],
    [ 0.16, -0.13, .130, .130, .58, mDark,   'tower'],
    [-0.32,  0.06, .115, .18,  .30, mConc,   'block'],
    [ 0.29,  0.09, .135, .115, .26, mDark,   'block'],
    [-0.05,  0.20, .275, .095, .13, mConc,   'podium'],
    [-0.38, -0.22, .090, .090, .19, mDark,   'block'],
    [ 0.36, -0.24, .080, .100, .22, mConc,   'block'],
    [ 0.06, -0.33, .105, .085, .16, mDark,   'block'],
    [-0.23,  0.29, .095, .075, .11, mConc,   'block'],
    [ 0.33,  0.31, .085, .085, .08, mConc,   'block'],
  ];

  bldgs.forEach(([bx, bz, bw, bd, bh, mat, style]) => {
    const g = new THREE.Group();
    g.position.set(bx, 0, bz);

    const body = new THREE.Mesh(new THREE.BoxGeometry(bw, bh, bd), mat.clone());
    body.position.y = bh / 2;
    body.castShadow = true;
    body.receiveShadow = true;
    g.add(body);

    if (style === 'tower') {
      const sp = new THREE.Mesh(new THREE.ConeGeometry(bw * .07, bh * .22, 8), mAccent.clone());
      sp.position.y = bh + bh * .11;
      sp.castShadow = true;
      g.add(sp);

      const rows = Math.floor(bh * 16);
      for (let r = 1; r < rows; r++) {
        const y = r * (bh / rows);
        [-1, 1].forEach(side => {
          const wm = new THREE.Mesh(new THREE.PlaneGeometry(bw * .72, .007), mWin.clone());
          wm.position.set(side * (bw / 2 + .0005), y, 0);
          wm.rotation.y = side === 1 ? 0 : Math.PI;
          g.add(wm);
        });
      }
      
      const rng = new THREE.Mesh(new THREE.TorusGeometry(bw * .38, .007, 6, 20), mAccent.clone());
      rng.rotation.x = Math.PI / 2;
      rng.position.y = bh - .003;
      g.add(rng);
      
      const bc = new THREE.Mesh(new THREE.SphereGeometry(.006, 8, 8), mNeon(0x00e5ff));
      bc.position.y = bh + bh * .22;
      g.add(bc);

    } else if (style === 'block') {
      const rf = new THREE.Mesh(new THREE.BoxGeometry(bw * .6, .013, bd * .6), mConc.clone());
      rf.position.y = bh + .006;
      g.add(rf);
      
      for (let i = 0; i < 2; i++) {
        const ac = new THREE.Mesh(new THREE.BoxGeometry(.016, .011, .020), mDark.clone());
        ac.position.set((i - .5) * .038, bh + .015, 0);
        g.add(ac);
      }

    } else if (style === 'podium') {
      const st = new THREE.Mesh(new THREE.BoxGeometry(bw * .65, bh * .28, bd * .65), mConc.clone());
      st.position.y = bh + bh * .14;
      g.add(st);
    }

    root.add(g);
  });

  // Elevated bridge
  const br = new THREE.Mesh(new THREE.BoxGeometry(.32, .011, .022), mDark.clone());
  br.position.set(-.02, .21, -.13);
  root.add(br);

  // Street lamps
  [[-0.22, .025], [.22, .025], [-0.22, -.025], [.22, -.025]].forEach(([x, z]) => {
    const pole = new THREE.Mesh(new THREE.CylinderGeometry(.003, .003, .075, 6), mConc.clone());
    pole.position.set(x, .0375, z);
    root.add(pole);
    
    const lamp = new THREE.Mesh(new THREE.SphereGeometry(.005, 6, 6), mNeon(0xffffaa));
    lamp.position.set(x, .078, z);
    root.add(lamp);
  });

  // Neon sign
  const ns = new THREE.Mesh(new THREE.BoxGeometry(.055, .011, .002), mNeon(0x00e5ff));
  ns.position.set(-.05, .143, .185);
  root.add(ns);

  // Ground glow
  const gg = new THREE.Mesh(new THREE.CircleGeometry(.26, 32),
    new THREE.MeshBasicMaterial({ color:0x001a22, transparent:true, opacity:.65 }));
  gg.rotation.x = -Math.PI / 2;
  gg.position.y = 0.0003;
  root.add(gg);

  // Central plaza
  const pl = new THREE.Mesh(new THREE.BoxGeometry(.11, .005, .11),
    new THREE.MeshPhongMaterial({ color:0x252535, shininess:8 }));
  pl.position.y = .0025;
  root.add(pl);

  // Plaza trees
  [[-0.038, -.038], [.038, -.038], [-.038, .038], [.038, .038]].forEach(([x, z]) => {
    const t = new THREE.Mesh(new THREE.ConeGeometry(.008, .022, 6), mTree.clone());
    t.position.set(x, .011, z);
    root.add(t);
  });
}

/* =====================================================
   ANNOTATION LINES
===================================================== */
const _vp = new THREE.Vector3();
function proj(lx, ly, lz) {
  _vp.set(lx, ly, lz);
  _vp.applyMatrix4(city.matrixWorld);
  _vp.project(camera);
  return {
    x: (_vp.x *  0.5 + 0.5) * window.innerWidth,
    y: (_vp.y * -0.5 + 0.5) * window.innerHeight,
    behind: _vp.z > 1
  };
}

function edgePt(id, tx, ty) {
  const el = document.getElementById(id);
  const r = el.getBoundingClientRect();
  const cx = r.left + r.width / 2;
  const cy = r.top + r.height / 2;
  const dx = tx - cx, dy = ty - cy;
  const len = Math.hypot(dx, dy) || 1;
  return {
    x: Math.max(r.left, Math.min(r.right, cx + (dx / len) * (r.width / 2 + 4))),
    y: Math.max(r.top, Math.min(r.bottom, cy + (dy / len) * (r.height / 2 + 4)))
  };
}

function drawAnnLines() {
  if (spawnPct < 0.35) return;
  const svg = document.getElementById('asvg');
  svg.innerHTML = '';
  const alpha = Math.min(1, (spawnPct - 0.35) / 0.35);

  ANNS.forEach(a => {
    const el = document.getElementById(a.id);
    if (!el.classList.contains('on')) return;

    const pt = proj(...a.lp);
    if (pt.behind) return;

    const edge = edgePt(a.id, pt.x, pt.y);
    const midX = a.side === 'left' ? (pt.x + edge.x) / 2 - 16 : (pt.x + edge.x) / 2 + 16;
    const midY = (pt.y + edge.y) / 2;

    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    path.setAttribute('d', `M${edge.x},${edge.y} L${midX},${midY} L${pt.x},${pt.y}`);
    path.setAttribute('stroke', `rgba(0,229,255,${0.48 * alpha})`);
    path.setAttribute('stroke-width', '0.85');
    path.setAttribute('stroke-dasharray', '4 3');
    path.setAttribute('fill', 'none');
    svg.appendChild(path);

    const dot = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    dot.setAttribute('cx', pt.x);
    dot.setAttribute('cy', pt.y);
    dot.setAttribute('r', '2.5');
    dot.setAttribute('fill', `rgba(0,229,255,${0.9 * alpha})`);
    svg.appendChild(dot);

    const ring = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    ring.setAttribute('cx', pt.x);
    ring.setAttribute('cy', pt.y);
    ring.setAttribute('r', '5.5');
    ring.setAttribute('fill', 'none');
    ring.setAttribute('stroke', `rgba(0,229,255,${0.28 * alpha})`);
    ring.setAttribute('stroke-width', '1');
    svg.appendChild(ring);

    const tw = a.side === 'left' ? -8 : 8;
    const tick = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    tick.setAttribute('x1', edge.x);
    tick.setAttribute('y1', edge.y);
    tick.setAttribute('x2', edge.x + tw);
    tick.setAttribute('y2', edge.y);
    tick.setAttribute('stroke', `rgba(0,229,255,${0.62 * alpha})`);
    tick.setAttribute('stroke-width', '1.4');
    svg.appendChild(tick);
  });
}
</script>
</body>
</html>