<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
<title>AR City Viewer</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@700;800&display=swap" rel="stylesheet"/>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#06060c;--surface:#0c0c18;--border:#1a1a2e;
  --accent:#00e5ff;--accent2:#ff3060;--accent3:#ffdd00;--accent4:#a855f7;
  --text:#e8eeff;--muted:#404070;
  --mono:'Space Mono',monospace;--display:'Syne',sans-serif;
}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:var(--mono);overflow:hidden;touch-action:none;-webkit-tap-highlight-color:transparent}

/* ── LOADING SCREEN ── */
#loading{position:fixed;inset:0;z-index:100;display:flex;flex-direction:column;align-items:center;justify-content:center;background:var(--bg);transition:opacity .5s}
#loading.hide{opacity:0;pointer-events:none}
.grid{position:fixed;inset:0;pointer-events:none;background-image:linear-gradient(rgba(0,229,255,.025) 1px,transparent 1px),linear-gradient(90deg,rgba(0,229,255,.025) 1px,transparent 1px);background-size:40px 40px}
.load-hdr{position:absolute;top:0;left:0;right:0;padding:1.3rem 1.5rem;display:flex;align-items:center;justify-content:space-between;background:linear-gradient(180deg,rgba(6,6,12,.95),transparent);z-index:2}
.brand{font-family:var(--display);font-size:1rem;font-weight:800;letter-spacing:.06em}
.brand em{font-style:normal;color:var(--accent)}
.spill{display:flex;align-items:center;gap:.4rem;background:rgba(0,229,255,.07);border:1px solid rgba(0,229,255,.2);border-radius:50px;padding:.26rem .8rem;font-size:.58rem;letter-spacing:.14em;text-transform:uppercase;color:var(--accent)}
.pd{width:6px;height:6px;border-radius:50%;background:var(--accent);animation:blink 1.4s infinite}

.spinner{width:60px;height:60px;border:3px solid rgba(0,229,255,.1);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite;margin-bottom:1.5rem}
.load-msg{font-size:.72rem;color:var(--muted);text-align:center;max-width:320px;line-height:1.8;padding:0 1rem}
.load-msg strong{color:var(--text);display:block;margin-bottom:.3rem}

#start-btn{margin-top:2rem;background:linear-gradient(135deg,var(--accent),#0099bb);color:#06060c;font-family:var(--display);font-size:.9rem;font-weight:800;letter-spacing:.1em;text-transform:uppercase;border:none;border-radius:50px;padding:.85rem 2.2rem;cursor:pointer;box-shadow:0 0 44px rgba(0,229,255,.4);transition:transform .2s;display:none}
#start-btn.show{display:block}
#start-btn:active{transform:scale(.95)}

/* ── AR CONTAINER ── */
#ar-container{position:fixed;inset:0;z-index:1;display:none}
#ar-video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
#ar-canvas{position:absolute;inset:0;width:100%;height:100%}

/* ── AR HUD ── */
.arhud{position:fixed;top:0;left:0;right:0;z-index:30;padding:.9rem 1.3rem;background:linear-gradient(180deg,rgba(0,0,0,.82),transparent);display:none;align-items:center;gap:.7rem;pointer-events:none}
.arhud.show{display:flex}
.arhtitle{font-family:var(--display);font-size:.9rem;font-weight:800;color:#fff;flex:1;letter-spacing:.04em}
.arlive{display:flex;align-items:center;gap:.3rem;font-size:.55rem;letter-spacing:.12em;text-transform:uppercase;color:var(--accent);background:rgba(0,229,255,.1);border:1px solid rgba(0,229,255,.2);border-radius:50px;padding:.25rem .7rem}
.arxbtn{width:32px;height:32px;border-radius:50%;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.1);color:#fff;font-size:.88rem;cursor:pointer;display:flex;align-items:center;justify-content:center;pointer-events:auto;transition:background .2s}
.arxbtn:hover{background:rgba(255,255,255,.22)}

#astatus{position:fixed;top:3.8rem;left:50%;transform:translateX(-50%);z-index:30;background:rgba(0,0,0,.55);border:1px solid rgba(255,255,255,.1);backdrop-filter:blur(10px);border-radius:50px;padding:.38rem 1rem;font-size:.58rem;letter-spacing:.1em;color:rgba(255,255,255,.7);white-space:nowrap;display:none;align-items:center;gap:.4rem;transition:border-color .3s,color .3s}
#astatus.show{display:flex}
#astatus.locked{border-color:rgba(0,229,255,.35);color:var(--accent)}

/* Annotation panels */
.ann{position:fixed;z-index:26;pointer-events:none;opacity:0;transition:opacity .6s}
.ann.on{opacity:1}
.atag{font-size:.54rem;letter-spacing:.16em;text-transform:uppercase;color:var(--accent);margin-bottom:.15rem;display:flex;align-items:center;gap:.3rem}
.atag::before{content:'';width:3px;height:3px;border-radius:50%;background:var(--accent);display:inline-block;flex-shrink:0}
.abig{font-family:var(--display);font-size:.9rem;font-weight:800;color:var(--text);line-height:1.1;margin-bottom:.1rem}
.abig.gold{color:var(--accent3)}
.asml{font-size:.52rem;color:var(--muted);letter-spacing:.07em;line-height:1.75}
.abar{height:1.5px;width:65px;background:linear-gradient(90deg,var(--accent),transparent);margin:.3rem 0;border-radius:1px}
.abar.r{background:linear-gradient(270deg,var(--accent),transparent)}

.arfoot{position:fixed;bottom:0;left:0;right:0;z-index:30;padding:1.1rem 1.3rem .9rem;background:linear-gradient(0deg,rgba(0,0,0,.9),transparent);display:none;align-items:flex-end;gap:.8rem}
.arfoot.show{display:flex}
.afm{flex:1}
.afsup{font-size:.5rem;letter-spacing:.18em;color:var(--muted);text-transform:uppercase;margin-bottom:.2rem}
.afname{font-family:var(--display);font-size:1.2rem;font-weight:800;line-height:1;color:var(--text)}
.afsub{font-size:.56rem;color:var(--accent);letter-spacing:.12em;margin-top:.18rem}
.afprice{font-family:var(--display);font-size:1.4rem;font-weight:800;color:var(--accent3);text-align:right}
.afdiv{width:1px;height:40px;background:var(--border)}

.sflash{position:fixed;inset:0;background:rgba(0,229,255,.08);pointer-events:none;z-index:28;animation:flash .7s ease-out forwards}

#asvg{position:fixed;inset:0;width:100%;height:100%;z-index:25;pointer-events:none;overflow:visible}

.instructions{position:fixed;bottom:6rem;left:50%;transform:translateX(-50%);z-index:30;background:rgba(0,0,0,.7);border:1px solid rgba(0,229,255,.3);backdrop-filter:blur(10px);border-radius:12px;padding:1rem 1.5rem;font-size:.65rem;color:var(--muted);text-align:center;max-width:320px;line-height:1.8;display:none}
.instructions.show{display:block}
.instructions strong{color:var(--accent);display:block;margin-bottom:.3rem;font-size:.72rem;letter-spacing:.08em}

@keyframes blink{0%,100%{opacity:1}50%{opacity:.2}}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes flash{0%{opacity:.6}100%{opacity:0}}
</style>
</head>
<body>

<!-- LOADING SCREEN -->
<div id="loading">
  <div class="grid"></div>
  <div class="load-hdr">
    <span class="brand">AR<em>CITY</em></span>
    <div class="spill"><span class="pd"></span><span id="stxt">READY</span></div>
  </div>
  <div class="spinner"></div>
  <p class="load-msg"><strong>AR City Viewer</strong>Point your camera at any printed QR code to see a 3D city float above it</p>
  <button id="start-btn" class="show">START AR</button>
</div>

<!-- AR CONTAINER -->
<div id="ar-container">
  <video id="ar-video" autoplay playsinline muted></video>
  <canvas id="ar-canvas"></canvas>
</div>

<!-- AR HUD -->
<div class="arhud" id="hud">
  <span class="arhtitle">AR CITY VIEWER</span>
  <div class="arlive"><span class="pd"></span>LIVE</div>
  <button class="arxbtn" onclick="stopAR()">✕</button>
</div>

<div id="astatus"><span>⟳</span><span id="atxt">Looking for QR code…</span></div>

<div class="instructions" id="instructions">
  <strong>Point at any QR code</strong>
  The city will appear floating above it
</div>

<!-- Annotations -->
<div class="ann" id="ann-a">
  <div class="atag">Development</div>
  <div class="abig">NOVA TOWER</div>
  <div class="asml">Mixed Use · 62 Floors</div>
  <div class="abar"></div>
  <div class="asml">HEIGHT · 312 m<br/>GFA · 184,000 m²<br/>STATUS · UNDER CONST.</div>
</div>
<div class="ann" id="ann-b">
  <div class="atag" style="justify-content:flex-end">Valuation</div>
  <div class="abig gold" style="text-align:right">$2.4B</div>
  <div class="asml" style="text-align:right">Projected 2027</div>
  <div class="abar r" style="margin-left:auto"></div>
  <div class="asml" style="text-align:right">YIELD · 6.8% p.a.<br/>UNITS · 480 RESI<br/>RATING · AA+</div>
</div>
<div class="ann" id="ann-c">
  <div class="atag">Infrastructure</div>
  <div class="abig" style="font-size:.78rem;line-height:1.3">District<br/>Node A-7</div>
  <div class="abar"></div>
  <div class="asml">ROADS · 4-LANE<br/>METRO · 200m<br/>FIBER · GIGABIT</div>
</div>
<div class="ann" id="ann-d">
  <div style="background:rgba(168,85,247,.12);border:1px solid rgba(168,85,247,.28);border-radius:5px;padding:.38rem .6rem;display:inline-block">
    <div style="font-size:.5rem;letter-spacing:.14em;color:var(--accent4)">SMART CITY</div>
    <div style="font-family:var(--display);font-size:.75rem;font-weight:800;color:var(--text);margin-top:.1rem">ISO 37122</div>
  </div>
</div>

<div class="arfoot" id="footer">
  <div class="afm">
    <div class="afsup">AR / 2024 / MASTERPLAN</div>
    <div class="afname">Nova District</div>
    <div class="afsub">40.7128°N · 74.0060°W</div>
  </div>
  <div class="afdiv"></div>
  <div class="afprice">$2.4<span style="font-size:.7rem">B</span></div>
</div>

<svg id="asvg"></svg>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<script>
/* =====================================================
   STATE
===================================================== */
let video, canvas, ctx, renderer, scene, camera, city;
let animationId, trackingInterval;
let markerVisible = false, spawnPct = 0, annShown = false;
let T = 0;

// Marker tracking
let markerMatrix = new THREE.Matrix4();
let markerPos = new THREE.Vector3();
let markerRot = new THREE.Euler();
let markerScale = 1;
let smoothPos = new THREE.Vector3();
let smoothRot = new THREE.Euler();
let smoothScale = 0.01;

const ANNS = [
  { id: 'ann-a', lp: [-0.18, 0.95, 0],  side: 'left'  },
  { id: 'ann-b', lp: [ 0.18, 0.90, 0],  side: 'right' },
  { id: 'ann-c', lp: [-0.10, 0.28, 0],  side: 'left'  },
  { id: 'ann-d', lp: [ 0.09, 0.74, 0],  side: 'right' },
];
const ANN_POS = {
  'ann-a': { left: '3vw',  top: '18%', right: 'auto', bottom: 'auto' },
  'ann-b': { right:'3vw',  top: '18%', left:  'auto', bottom: 'auto' },
  'ann-c': { left: '3vw',  top: '63%', right: 'auto', bottom: 'auto' },
  'ann-d': { right:'3vw',  top: '63%', left:  'auto', bottom: 'auto' },
};

/* =====================================================
   INIT
===================================================== */
document.getElementById('start-btn').addEventListener('click', startAR);

async function startAR() {
  try {
    // Get camera stream
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { 
        facingMode: 'environment',
        width: { ideal: 1280 },
        height: { ideal: 720 }
      },
      audio: false
    });

    video = document.getElementById('ar-video');
    video.srcObject = stream;
    await video.play();

    // Setup canvas for QR detection
    canvas = document.createElement('canvas');
    canvas.width = 640;
    canvas.height = 480;
    ctx = canvas.getContext('2d', { willReadFrequently: true });

    // Setup Three.js
    setupThreeJS();

    // Show AR interface
    document.getElementById('loading').classList.add('hide');
    document.getElementById('ar-container').style.display = 'block';
    document.getElementById('hud').classList.add('show');
    document.getElementById('astatus').classList.add('show');
    document.getElementById('instructions').classList.add('show');
    document.getElementById('footer').classList.add('show');

    // Start tracking and rendering
    trackingInterval = setInterval(trackQR, 100);
    animate();

  } catch (error) {
    console.error('Camera error:', error);
    document.querySelector('.load-msg').innerHTML = `<strong>Camera Access Required</strong>Please allow camera access in your browser settings and reload the page.<br/><br/><small>${error.message}</small>`;
    document.getElementById('start-btn').style.display = 'none';
  }
}

function stopAR() {
  if (video && video.srcObject) {
    video.srcObject.getTracks().forEach(track => track.stop());
  }
  if (animationId) cancelAnimationFrame(animationId);
  if (trackingInterval) clearInterval(trackingInterval);
  window.location.reload();
}

/* =====================================================
   THREE.JS SETUP
===================================================== */
function setupThreeJS() {
  const arCanvas = document.getElementById('ar-canvas');
  renderer = new THREE.WebGLRenderer({ canvas: arCanvas, alpha: true, antialias: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
  renderer.setClearColor(0x000000, 0);
  renderer.shadowMap.enabled = true;
  renderer.shadowMap.type = THREE.PCFSoftShadowMap;

  scene = new THREE.Scene();
  
  // Camera setup - FOV matches typical phone camera
  camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.01, 1000);
  camera.position.set(0, 0, 0);
  scene.add(camera);

  // Lights
  scene.add(new THREE.AmbientLight(0xffffff, 0.6));
  
  const sun = new THREE.DirectionalLight(0xfff8e0, 1.0);
  sun.position.set(2, 4, 3);
  sun.castShadow = true;
  sun.shadow.mapSize.setScalar(1024);
  sun.shadow.camera.near = 0.1;
  sun.shadow.camera.far = 20;
  sun.shadow.camera.left = sun.shadow.camera.bottom = -2;
  sun.shadow.camera.right = sun.shadow.camera.top = 2;
  scene.add(sun);
  
  const fill = new THREE.DirectionalLight(0xaaccff, 0.4);
  fill.position.set(-3, 2, -2);
  scene.add(fill);
  
  const rim = new THREE.DirectionalLight(0x00e5ff, 0.25);
  rim.position.set(0, 4, -5);
  scene.add(rim);

  // Build city
  city = new THREE.Group();
  city.visible = false;
  scene.add(city);
  buildCity(city);

  window.addEventListener('resize', onResize);
}

/* =====================================================
   QR TRACKING
===================================================== */
function trackQR() {
  if (!video || video.readyState < 2) return;
  
  ctx.drawImage(video, 0, 0, 640, 480);
  const imageData = ctx.getImageData(0, 0, 640, 480);
  const code = jsQR(imageData.data, 640, 480, { inversionAttempts: 'dontInvert' });

  if (code) {
    if (!markerVisible) {
      onMarkerFound();
    }
    updateMarkerPose(code.location);
    markerVisible = true;
    
    document.getElementById('astatus').classList.add('locked');
    document.getElementById('atxt').textContent = 'QR code locked';
  } else {
    if (markerVisible) {
      onMarkerLost();
    }
    markerVisible = false;
  }
}

function updateMarkerPose(location) {
  const W = 640, H = 480;
  
  // Get corner positions in normalized device coordinates
  const corners = [
    { x: location.topLeftCorner.x / W * 2 - 1, y: -(location.topLeftCorner.y / H * 2 - 1) },
    { x: location.topRightCorner.x / W * 2 - 1, y: -(location.topRightCorner.y / H * 2 - 1) },
    { x: location.bottomRightCorner.x / W * 2 - 1, y: -(location.bottomRightCorner.y / H * 2 - 1) },
    { x: location.bottomLeftCorner.x / W * 2 - 1, y: -(location.bottomLeftCorner.y / H * 2 - 1) }
  ];
  
  // Calculate center position
  const centerX = (corners[0].x + corners[1].x + corners[2].x + corners[3].x) / 4;
  const centerY = (corners[0].y + corners[1].y + corners[2].y + corners[3].y) / 4;
  
  // Calculate marker size in screen space
  const sizeX = Math.abs(corners[1].x - corners[0].x);
  const sizeY = Math.abs(corners[2].y - corners[1].y);
  const markerSize = (sizeX + sizeY) / 2;
  
  // FIXED DISTANCE - this is the key parameter to adjust
  const distance = 1.2; // meters from camera
  
  // Calculate world position
  const fov = THREE.MathUtils.degToRad(camera.fov);
  const viewportHeight = 2 * Math.tan(fov / 2) * distance;
  const viewportWidth = viewportHeight * camera.aspect;
  
  markerPos.x = centerX * viewportWidth / 2;
  markerPos.y = centerY * viewportHeight / 2;
  markerPos.z = -distance;
  
  // Calculate rotation (simplified - just yaw for now)
  const dx = corners[1].x - corners[0].x;
  const dy = corners[1].y - corners[0].y;
  const yaw = Math.atan2(dy, dx);
  
  markerRot.set(0, yaw, 0);
  
  // FIXED SCALE - this determines city size
  // The city should be proportional to the QR code size
  const qrSizeInWorld = markerSize * viewportWidth / 2;
  markerScale = qrSizeInWorld * 0.8; // 80% of QR code size
}

function onMarkerFound() {
  console.log('Marker found!');
  city.visible = true;
  spawnPct = 0;
  
  // Flash effect
  const flash = document.createElement('div');
  flash.className = 'sflash';
  document.body.appendChild(flash);
  setTimeout(() => flash.remove(), 700);
  
  // Show annotations after delay
  setTimeout(() => {
    if (markerVisible) showAnnotations();
  }, 1200);
}

function onMarkerLost() {
  console.log('Marker lost');
  document.getElementById('astatus').classList.remove('locked');
  document.getElementById('atxt').textContent = 'Looking for QR code…';
  hideAnnotations();
}

function showAnnotations() {
  annShown = true;
  ANNS.forEach(a => {
    const el = document.getElementById(a.id);
    Object.assign(el.style, ANN_POS[a.id]);
    el.classList.add('on');
  });
}

function hideAnnotations() {
  annShown = false;
  document.querySelectorAll('.ann').forEach(el => el.classList.remove('on'));
  document.getElementById('asvg').innerHTML = '';
}

/* =====================================================
   ANIMATION LOOP
===================================================== */
function animate() {
  animationId = requestAnimationFrame(animate);
  T += 0.016;
  
  if (markerVisible) {
    // Smooth interpolation
    smoothPos.lerp(markerPos, 0.25);
    smoothRot.x += (markerRot.x - smoothRot.x) * 0.2;
    smoothRot.y += (markerRot.y - smoothRot.y) * 0.2;
    smoothRot.z += (markerRot.z - smoothRot.z) * 0.2;
    smoothScale += (markerScale - smoothScale) * 0.15;
    
    // Grow in effect
    if (spawnPct < 1) {
      spawnPct = Math.min(1, spawnPct + 0.03);
    }
    
    // Apply transform to city
    city.position.copy(smoothPos);
    city.position.y += 0.15 * smoothScale; // Lift above marker
    city.rotation.copy(smoothRot);
    city.scale.setScalar(smoothScale * spawnPct);
    
    // Subtle floating animation
    city.position.y += Math.sin(T * 0.8) * 0.008 * smoothScale;
    city.rotation.y += Math.sin(T * 0.3) * 0.02;
  }
  
  if (annShown && markerVisible) {
    drawAnnLines();
  }
  
  renderer.render(scene, camera);
}

/* =====================================================
   CITY BUILDER
===================================================== */
function buildCity(root) {
  const mGlass = new THREE.MeshPhongMaterial({ color:0x88ccdd, emissive:0x002233, shininess:130, specular:0x88ccdd, transparent:true, opacity:.92 });
  const mConc  = new THREE.MeshPhongMaterial({ color:0xaaaacc, emissive:0x050510, shininess:18 });
  const mDark  = new THREE.MeshPhongMaterial({ color:0x1e2f44, emissive:0x050510, shininess:55 });
  const mAccent= new THREE.MeshPhongMaterial({ color:0x00e5ff, emissive:0x004455, shininess:150, specular:0x00e5ff });
  const mRoad  = new THREE.MeshPhongMaterial({ color:0x181822, shininess:4 });
  const mGnd   = new THREE.MeshPhongMaterial({ color:0x111118, shininess:2, transparent:true, opacity:0.7 });
  const mWin   = new THREE.MeshPhongMaterial({ color:0x1a3355, emissive:0x0a1a2a, shininess:70, transparent:true, opacity:.82 });
  const mNeon  = c => new THREE.MeshPhongMaterial({ color:c, emissive:c, emissiveIntensity:1.3 });
  const mTree  = new THREE.MeshPhongMaterial({ color:0x1a4422, emissive:0x060f08 });

  // Ground
  const gnd = new THREE.Mesh(new THREE.PlaneGeometry(1, 1), mGnd);
  gnd.rotation.x = -Math.PI / 2;
  gnd.receiveShadow = true;
  root.add(gnd);

  // Roads
  [[1,0.04],[0.04,1]].forEach(([w,d]) => {
    const r = new THREE.Mesh(new THREE.PlaneGeometry(w, d), mRoad);
    r.rotation.x = -Math.PI / 2;
    r.position.y = 0.0005;
    root.add(r);
  });

  // Buildings
  const bldgs = [
    [-0.18, -0.12, .155, .155, .75, mGlass,  'tower'],
    [ 0.16, -0.13, .130, .130, .58, mDark,   'tower'],
    [-0.32,  0.06, .115, .18,  .30, mConc,   'block'],
    [ 0.29,  0.09, .135, .115, .26, mDark,   'block'],
    [-0.05,  0.20, .275, .095, .13, mConc,   'podium'],
    [-0.38, -0.22, .090, .090, .19, mDark,   'block'],
    [ 0.36, -0.24, .080, .100, .22, mConc,   'block'],
    [ 0.06, -0.33, .105, .085, .16, mDark,   'block'],
    [-0.23,  0.29, .095, .075, .11, mConc,   'block'],
    [ 0.33,  0.31, .085, .085, .08, mConc,   'block'],
  ];

  bldgs.forEach(([bx, bz, bw, bd, bh, mat, style]) => {
    const g = new THREE.Group();
    g.position.set(bx, 0, bz);

    const body = new THREE.Mesh(new THREE.BoxGeometry(bw, bh, bd), mat.clone());
    body.position.y = bh / 2;
    body.castShadow = true;
    body.receiveShadow = true;
    g.add(body);

    if (style === 'tower') {
      const sp = new THREE.Mesh(new THREE.ConeGeometry(bw * .07, bh * .22, 8), mAccent.clone());
      sp.position.y = bh + bh * .11;
      sp.castShadow = true;
      g.add(sp);

      const rows = Math.floor(bh * 16);
      for (let r = 1; r < rows; r++) {
        const y = r * (bh / rows);
        [-1, 1].forEach(side => {
          const wm = new THREE.Mesh(new THREE.PlaneGeometry(bw * .72, .007), mWin.clone());
          wm.position.set(side * (bw / 2 + .0005), y, 0);
          wm.rotation.y = side === 1 ? 0 : Math.PI;
          g.add(wm);
        });
      }
      
      const rng = new THREE.Mesh(new THREE.TorusGeometry(bw * .38, .007, 6, 20), mAccent.clone());
      rng.rotation.x = Math.PI / 2;
      rng.position.y = bh - .003;
      g.add(rng);
      
      const bc = new THREE.Mesh(new THREE.SphereGeometry(.006, 8, 8), mNeon(0x00e5ff));
      bc.position.y = bh + bh * .22;
      g.add(bc);

    } else if (style === 'block') {
      const rf = new THREE.Mesh(new THREE.BoxGeometry(bw * .6, .013, bd * .6), mConc.clone());
      rf.position.y = bh + .006;
      g.add(rf);
      
      for (let i = 0; i < 2; i++) {
        const ac = new THREE.Mesh(new THREE.BoxGeometry(.016, .011, .020), mDark.clone());
        ac.position.set((i - .5) * .038, bh + .015, 0);
        g.add(ac);
      }

    } else if (style === 'podium') {
      const st = new THREE.Mesh(new THREE.BoxGeometry(bw * .65, bh * .28, bd * .65), mConc.clone());
      st.position.y = bh + bh * .14;
      g.add(st);
    }

    root.add(g);
  });

  // Elevated bridge
  const br = new THREE.Mesh(new THREE.BoxGeometry(.32, .011, .022), mDark.clone());
  br.position.set(-.02, .21, -.13);
  root.add(br);

  // Street lamps
  [[-0.22, .025], [.22, .025], [-0.22, -.025], [.22, -.025]].forEach(([x, z]) => {
    const pole = new THREE.Mesh(new THREE.CylinderGeometry(.003, .003, .075, 6), mConc.clone());
    pole.position.set(x, .0375, z);
    root.add(pole);
    
    const lamp = new THREE.Mesh(new THREE.SphereGeometry(.005, 6, 6), mNeon(0xffffaa));
    lamp.position.set(x, .078, z);
    root.add(lamp);
  });

  // Neon sign
  const ns = new THREE.Mesh(new THREE.BoxGeometry(.055, .011, .002), mNeon(0x00e5ff));
  ns.position.set(-.05, .143, .185);
  root.add(ns);

  // Ground glow
  const gg = new THREE.Mesh(new THREE.CircleGeometry(.26, 32),
    new THREE.MeshBasicMaterial({ color:0x001a22, transparent:true, opacity:.65 }));
  gg.rotation.x = -Math.PI / 2;
  gg.position.y = 0.0003;
  root.add(gg);

  // Central plaza
  const pl = new THREE.Mesh(new THREE.BoxGeometry(.11, .005, .11),
    new THREE.MeshPhongMaterial({ color:0x252535, shininess:8 }));
  pl.position.y = .0025;
  root.add(pl);

  // Plaza trees
  [[-0.038, -.038], [.038, -.038], [-.038, .038], [.038, .038]].forEach(([x, z]) => {
    const t = new THREE.Mesh(new THREE.ConeGeometry(.008, .022, 6), mTree.clone());
    t.position.set(x, .011, z);
    root.add(t);
  });
}

/* =====================================================
   ANNOTATION LINES
===================================================== */
const _vp = new THREE.Vector3();
function proj(lx, ly, lz) {
  _vp.set(lx, ly, lz);
  _vp.applyMatrix4(city.matrixWorld);
  _vp.project(camera);
  return {
    x: (_vp.x *  0.5 + 0.5) * window.innerWidth,
    y: (_vp.y * -0.5 + 0.5) * window.innerHeight,
    behind: _vp.z > 1
  };
}

function edgePt(id, tx, ty) {
  const el = document.getElementById(id);
  const r = el.getBoundingClientRect();
  const cx = r.left + r.width / 2;
  const cy = r.top + r.height / 2;
  const dx = tx - cx, dy = ty - cy;
  const len = Math.hypot(dx, dy) || 1;
  return {
    x: Math.max(r.left, Math.min(r.right, cx + (dx / len) * (r.width / 2 + 4))),
    y: Math.max(r.top, Math.min(r.bottom, cy + (dy / len) * (r.height / 2 + 4)))
  };
}

function drawAnnLines() {
  if (spawnPct < 0.35) return;
  const svg = document.getElementById('asvg');
  svg.innerHTML = '';
  const alpha = Math.min(1, (spawnPct - 0.35) / 0.35);

  ANNS.forEach(a => {
    const el = document.getElementById(a.id);
    if (!el.classList.contains('on')) return;

    const pt = proj(...a.lp);
    if (pt.behind) return;

    const edge = edgePt(a.id, pt.x, pt.y);
    const midX = a.side === 'left' ? (pt.x + edge.x) / 2 - 16 : (pt.x + edge.x) / 2 + 16;
    const midY = (pt.y + edge.y) / 2;

    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    path.setAttribute('d', `M${edge.x},${edge.y} L${midX},${midY} L${pt.x},${pt.y}`);
    path.setAttribute('stroke', `rgba(0,229,255,${0.48 * alpha})`);
    path.setAttribute('stroke-width', '0.85');
    path.setAttribute('stroke-dasharray', '4 3');
    path.setAttribute('fill', 'none');
    svg.appendChild(path);

    const dot = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    dot.setAttribute('cx', pt.x);
    dot.setAttribute('cy', pt.y);
    dot.setAttribute('r', '2.5');
    dot.setAttribute('fill', `rgba(0,229,255,${0.9 * alpha})`);
    svg.appendChild(dot);

    const ring = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    ring.setAttribute('cx', pt.x);
    ring.setAttribute('cy', pt.y);
    ring.setAttribute('r', '5.5');
    ring.setAttribute('fill', 'none');
    ring.setAttribute('stroke', `rgba(0,229,255,${0.28 * alpha})`);
    ring.setAttribute('stroke-width', '1');
    svg.appendChild(ring);

    const tw = a.side === 'left' ? -8 : 8;
    const tick = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    tick.setAttribute('x1', edge.x);
    tick.setAttribute('y1', edge.y);
    tick.setAttribute('x2', edge.x + tw);
    tick.setAttribute('y2', edge.y);
    tick.setAttribute('stroke', `rgba(0,229,255,${0.62 * alpha})`);
    tick.setAttribute('stroke-width', '1.4');
    svg.appendChild(tick);
  });
}

function onResize() {
  if (camera && renderer) {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  }
}
</script>
</body>
</html>