<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
<title>AR City Viewer – Any QR</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@700;800&display=swap" rel="stylesheet"/>
<style>
  *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
  :root{
    --bg:#06060c;--surface:#0c0c18;--border:#1a1a2e;
    --accent:#00e5ff;--accent2:#ff3060;--accent3:#ffdd00;--accent4:#a855f7;
    --text:#e8eeff;--muted:#404070;
    --mono:'Space Mono',monospace;--display:'Syne',sans-serif;
  }
  html,body{height:100%;background:var(--bg);color:var(--text);font-family:var(--mono);overflow:hidden;touch-action:none}
  #ar-screen{position:fixed;inset:0;z-index:1;background:#000}
  video,#acv{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
  #acv{pointer-events:none}
  #asvg{position:absolute;inset:0;width:100%;height:100%;z-index:5;pointer-events:none;overflow:visible}
  #status{position:absolute;top:1rem;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.65);backdrop-filter:blur(10px);padding:.6rem 1.4rem;border-radius:50px;font-size:.9rem;color:var(--accent);border:1px solid rgba(0,229,255,.3);white-space:nowrap;display:flex;align-items:center;gap:.6rem;z-index:20}
  #status.found{color:#88ffaa;border-color:#88ffaa}
  .ann{position:absolute;z-index:15;pointer-events:none;opacity:0;transition:opacity .6s;padding:.9rem 1.4rem;background:rgba(6,6,12,.8);border:1px solid rgba(0,229,255,.3);border-radius:10px;max-width:260px;font-size:.9rem;line-height:1.45}
  .ann.on{opacity:1}
  .atag{font-size:.7rem;letter-spacing:.12em;text-transform:uppercase;color:var(--accent);margin-bottom:.4rem}
  .abig{font-family:var(--display);font-size:1.25rem;font-weight:800;color:var(--text);margin:.2rem 0}
  .asml{font-size:.75rem;color:var(--muted)}
  .abar{height:2px;width:90px;background:linear-gradient(90deg,var(--accent),transparent);margin:.5rem 0;border-radius:1px}
  #hud{position:absolute;top:0;left:0;right:0;padding:1rem;display:flex;justify-content:space-between;align-items:center;z-index:25;pointer-events:none}
  .brand{font-family:var(--display);font-size:1.3rem;font-weight:800;letter-spacing:.05em}
  .brand em{font-style:normal;color:var(--accent)}
  .close-btn{width:44px;height:44px;border-radius:50%;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.18);color:#fff;font-size:1.3rem;cursor:pointer;pointer-events:auto;display:flex;align-items:center;justify-content:center;transition:.2s}
  .close-btn:hover{background:rgba(255,255,255,.18)}
</style>
</head>
<body>
<div id="ar-screen">
  <video id="video" autoplay playsinline muted></video>
  <canvas id="acv"></canvas>
  <svg id="asvg"></svg>

  <div id="status"><span style="width:10px;height:10px;border-radius:50%;background:var(--accent);animation:blink 1.6s infinite"></span> Looking for any QR code…</div>

  <!-- Annotations (appear when QR found) -->
  <div class="ann" id="ann-a" style="left:4%;top:18%">
    <div class="atag">Development</div>
    <div class="abig">NOVA TOWER</div>
    <div class="asml">Mixed Use · 62 Floors</div>
    <div class="abar"></div>
    <div class="asml">HEIGHT · 312 m<br>GFA · 184,000 m²<br>STATUS · UNDER CONST.</div>
  </div>
  <div class="ann" id="ann-b" style="right:4%;top:18%;text-align:right">
    <div class="atag">Valuation</div>
    <div class="abig" style="color:var(--accent3)">$2.4B</div>
    <div class="asml">Projected 2027</div>
    <div class="abar" style="margin-left:auto;background:linear-gradient(270deg,var(--accent3),transparent)"></div>
    <div class="asml">YIELD · 6.8% p.a.<br>UNITS · 480 RESI<br>RATING · AA+</div>
  </div>

  <div id="hud">
    <span class="brand">AR<em>CITY</em></span>
    <button class="close-btn" onclick="location.reload()">✕</button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r168/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

<script>
// ── Globals ──
const video = document.getElementById('video');
const canvas = document.getElementById('acv');
const ctx = canvas.getContext('2d', {willReadFrequently: true});
const svg = document.getElementById('asvg');
const status = document.getElementById('status');

let renderer, scene, camera, city, anchor;
let targetPos = new THREE.Vector3();
let targetRot = new THREE.Euler();
let targetScale = 1;
let qrVisible = false;
let frameCount = 0;
let T = 0;

// ── Init ──
async function init() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: 'environment', width: {ideal:1280}, height:{ideal:720} }
    });
    video.srcObject = stream;
    video.onloadedmetadata = () => video.play();

    renderer = new THREE.WebGLRenderer({canvas, alpha:true, antialias:true});
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true;

    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(50, innerWidth/innerHeight, 0.1, 1000);

    scene.add(new THREE.AmbientLight(0xffffff, 0.65));

    const sun = new THREE.DirectionalLight(0xfff8e0, 1.1);
    sun.position.set(6,12,10); sun.castShadow = true;
    scene.add(sun);

    anchor = new THREE.Group();
    scene.add(anchor);

    city = new THREE.Group();
    anchor.add(city);
    city.position.y = 0.35; // float above QR
    buildCity(city);

    window.addEventListener('resize', onResize);
    animate();
  } catch(e) {
    status.textContent = 'Camera access denied or error';
    console.error(e);
  }
}

function buildCity(root) {
  // Simplified version – add your full buildings/lamps/etc here
  const materials = {
    glass: new THREE.MeshPhongMaterial({color:0x88ccdd, emissive:0x002233, shininess:120, transparent:true, opacity:0.9}),
    dark: new THREE.MeshPhongMaterial({color:0x1e2f44, emissive:0x050510}),
    conc: new THREE.MeshPhongMaterial({color:0xaaaacc, emissive:0x050510, shininess:20}),
    neon: (col) => new THREE.MeshPhongMaterial({color:col, emissive:col, emissiveIntensity:1.4})
  };

  // Ground plane
  const ground = new THREE.Mesh(
    new THREE.PlaneGeometry(2,2),
    new THREE.MeshPhongMaterial({color:0x111118, transparent:true, opacity:0.6})
  );
  ground.rotation.x = -Math.PI/2;
  ground.receiveShadow = true;
  root.add(ground);

  // Example towers (expand with your original array)
  const buildings = [
    {pos:[-0.25,0,-0.15], size:[0.18,0.9,0.18], mat:materials.glass},
    {pos:[0.22,0,-0.12], size:[0.16,0.65,0.16], mat:materials.dark},
    {pos:[-0.08,0,0.25], size:[0.32,0.18,0.12], mat:materials.conc},
  ];

  buildings.forEach(b => {
    const g = new THREE.Group();
    g.position.set(...b.pos);
    const mesh = new THREE.Mesh(new THREE.BoxGeometry(...b.size), b.mat);
    mesh.position.y = b.size[1]/2;
    mesh.castShadow = mesh.receiveShadow = true;
    g.add(mesh);
    root.add(g);
  });

  // Add subtle glow or more details as in original
}

// ── Main Loop ──
function animate() {
  requestAnimationFrame(animate);
  T += 0.016;
  frameCount++;

  if (video.readyState >= video.HAVE_CURRENT_DATA) {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    if (frameCount % 3 === 0) { // scan every 3 frames
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const code = jsQR(imageData.data, imageData.width, imageData.height, {inversionAttempts: 'dontInvert'});

      if (code) {
        qrVisible = true;
        status.innerHTML = '<span style="width:10px;height:10px;border-radius:50%;background:#88ffaa"></span> QR Detected – City Anchored';
        status.classList.add('found');
        document.querySelectorAll('.ann').forEach(el => el.classList.add('on'));

        updatePoseFromQR(code.location);
      } else {
        qrVisible = false;
        status.innerHTML = '<span style="width:10px;height:10px;border-radius:50%;background:var(--accent);animation:blink 1.6s infinite"></span> Looking for any QR code…';
        status.classList.remove('found');
        document.querySelectorAll('.ann').forEach(el => el.classList.remove('on'));
      }
    }

    // Smooth apply
    anchor.position.lerp(targetPos, qrVisible ? 0.45 : 0.12);
    anchor.rotation.x += (targetRot.x - anchor.rotation.x) * (qrVisible ? 0.38 : 0.08);
    anchor.rotation.y += (targetRot.y - anchor.rotation.y) * (qrVisible ? 0.38 : 0.08);
    anchor.rotation.z += (targetRot.z - anchor.rotation.z) * (qrVisible ? 0.38 : 0.08);

    city.scale.lerp(new THREE.Vector3(targetScale, targetScale, targetScale), 0.25);

    // Gentle float & sway when visible
    if (qrVisible) {
      city.position.y = 0.35 + Math.sin(T * 1.2) * 0.012;
      city.rotation.y = Math.sin(T * 0.4) * 0.025;
    }
  }

  renderer.render(scene, camera);
}

function updatePoseFromQR(loc) {
  const W = canvas.width, H = canvas.height;

  // Corners in normalized [0,1]
  const corners = [
    {x: loc.topLeftCorner.x / W,     y: loc.topLeftCorner.y / H},
    {x: loc.topRightCorner.x / W,    y: loc.topRightCorner.y / H},
    {x: loc.bottomRightCorner.x / W, y: loc.bottomRightCorner.y / H},
    {x: loc.bottomLeftCorner.x / W,  y: loc.bottomLeftCorner.y / H},
  ];

  // Center
  const cx = (corners.reduce((s,c)=>s+c.x,0)/4 - 0.5) * 2;
  const cy = -((corners.reduce((s,c)=>s+c.y,0)/4 - 0.5) * 2);

  // Average side length in screen fraction
  const sides = [
    Math.hypot(corners[1].x - corners[0].x, corners[1].y - corners[0].y),
    Math.hypot(corners[2].x - corners[3].x, corners[2].y - corners[3].y),
    Math.hypot(corners[3].x - corners[0].x, corners[3].y - corners[0].y),
    Math.hypot(corners[2].x - corners[1].x, corners[2].y - corners[1].y),
  ];
  const avgSide = sides.reduce((a,b)=>a+b,0) / 4;

  // ── Tuning (most important) ──
  const NOMINAL_QR_NDC = 0.25;          // assume QR fills ~25% of screen width when held ~60-80cm away
  const BASE_SCALE = 1.0;               // model size when QR is "nominal"
  const DISTANCE_BASE = 1.1;            // meters – feels natural

  const scaleFactor = NOMINAL_QR_NDC / (avgSide + 0.001);
  targetScale = BASE_SCALE * scaleFactor * 0.9; // slightly smaller to avoid covering screen

  const depth = DISTANCE_BASE * scaleFactor; // farther when QR smaller

  const fovRad = THREE.MathUtils.degToRad(camera.fov);
  const heightAtDist = 2 * Math.tan(fovRad/2) * depth;
  const widthAtDist = heightAtDist * camera.aspect;

  targetPos.set(
    cx * (widthAtDist / 2),
    cy * (heightAtDist / 2),
    -depth
  );

  // Rough rotation (yaw from top edge, tilt from side differences)
  const yaw = Math.atan2(corners[1].x - corners[0].x, corners[1].y - corners[0].y);
  const tiltX = (sides[0] - sides[1]) * 3; // exaggerate less
  const tiltZ = (sides[3] - sides[2]) * 3;
  targetRot.set(tiltX * 0.5, yaw, tiltZ * 0.5);
}

function onResize() {
  camera.aspect = innerWidth / innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth, innerHeight);
}

@keyframes blink{0%,100%{opacity:1}50%{opacity:.15}}

// Start
init();
</script>
</body>
</html>